name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.24

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-1.24-${{ hashFiles('**/go.sum') }}

    - name: Download dependencies
      run: go mod download

    - name: Install swag
      run: go install github.com/swaggo/swag/cmd/swag@latest

    - name: Generate Swagger docs
      run: swag init

    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build binaries
      run: |
        # Create build directory
        mkdir -p build
        
        # Build for different platforms and architectures
        platforms=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
          "windows/amd64"
          "windows/arm64"
        )
        
        for platform in "${platforms[@]}"; do
          IFS='/' read -r GOOS GOARCH <<< "$platform"
          
          # Set binary name
          binary_name="onedock"
          if [ "$GOOS" = "windows" ]; then
            binary_name="onedock.exe"
          fi
          
          # Build binary
          echo "Building for $GOOS/$GOARCH..."
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
            -ldflags "-s -w -X main.version=${{ steps.get_version.outputs.VERSION }} -X main.buildTime=$(date -u '+%Y-%m-%d_%H:%M:%S')" \
            -o "build/${binary_name}_${GOOS}_${GOARCH}" \
            ./
            
          # Create archive
          if [ "$GOOS" = "windows" ]; then
            cd build && zip "onedock_${GOOS}_${GOARCH}.zip" "${binary_name}_${GOOS}_${GOARCH}" && cd ..
          else
            cd build && tar -czf "onedock_${GOOS}_${GOARCH}.tar.gz" "${binary_name}_${GOOS}_${GOARCH}" && cd ..
          fi
        done

    - name: Generate checksums
      run: |
        cd build
        sha256sum *.tar.gz *.zip > checksums.txt
        cd ..

    - name: Create release notes
      id: release_notes
      run: |
        # Extract version from tag
        VERSION=${{ steps.get_version.outputs.VERSION }}
        
        # Create release notes
        cat > release_notes.md << EOF
        # OneDock ${VERSION}
        
        ## 🚀 What's New
        
        This release includes various improvements and bug fixes.
        
        ## 📦 Downloads
        
        Choose the appropriate binary for your platform:
        
        ### Linux
        - **AMD64**: \`onedock_linux_amd64.tar.gz\`
        - **ARM64**: \`onedock_linux_arm64.tar.gz\`
        
        ### macOS
        - **Intel (AMD64)**: \`onedock_darwin_amd64.tar.gz\`
        - **Apple Silicon (ARM64)**: \`onedock_darwin_arm64.tar.gz\`
        
        ### Windows
        - **AMD64**: \`onedock_windows_amd64.zip\`
        - **ARM64**: \`onedock_windows_arm64.zip\`
        
        ## 📋 Installation
        
        ### Manual Installation
        1. Download the appropriate archive for your platform
        2. Extract the binary
        3. Make it executable (Linux/macOS): \`chmod +x onedock\`
        4. Move to your PATH or run directly
        
        ### Automated Installation (Linux with systemd)
        1. Download and extract the Linux binary
        2. Use the installation script: \`sudo ./deploy/install.sh\`
        
        **⚠️ Important**: OneDock should be deployed as a native binary, NOT as a Docker container, since it manages Docker containers itself.
        
        ## 🔒 Verification
        
        Verify your download with the checksums provided in \`checksums.txt\`.
        
        ## 📖 Documentation
        
        - [README](https://github.com/aichy126/onedock/blob/main/README.md)
        - [API Documentation](https://github.com/aichy126/onedock/blob/main/docs/)
        - [Contributing Guide](https://github.com/aichy126/onedock/blob/main/CONTRIBUTING.md)
        
        ## 🐛 Bug Reports
        
        Found a bug? Please [open an issue](https://github.com/aichy126/onedock/issues/new/choose).
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: OneDock ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
        files: |
          build/*.tar.gz
          build/*.zip
          build/checksums.txt
        generate_release_notes: true

